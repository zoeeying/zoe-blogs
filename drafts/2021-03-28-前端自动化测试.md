# Jest 学习笔记

`npx jest --init` 可以把 Jest 的配置暴露出来。

如果想测试 ESModule 代码，需要使用 Babel：

```bash
npm install @babel/core @babel/preset-env --save-dev
```

```json
{
  "presets": [
    ["@babel/preset-env", {
      "targets": {
        // 根据当前Node环境，结合@babel/preset-env对代码进行转换
        "node": "current"
      }
    }]
  ]
}
```

## 测试异步函数

对于异步函数，比如请求一个接口，普通的测试用例写法是无效的，需要特殊处理。

#### (1) 回调类型异步函数

```javascript
export function fetchData(fn) {
  axios.get('http://www.dell-lee.com/react/api/demo.json').then((res) => {
    fn(res.data)
  })
}
```

```javascript
test('test fetchData', (done) => {
  fetchData((data) => {
    expect(data).toEqual({
      success: true,
    })
    done()
  })
})
```

测试回调类型的异步函数使用了 done 函数，如果不使用的话，回调函数中的测试代码是执行不到的，只有调用了 done 函数，才表示该测试用例执行完成了。

#### (2) 返回 Promise 的异步函数

```javascript
export function fetchData() {
  return axios.get('http://www.dell-lee.com/react/api/demo.json')
}
```

如果接口请求成功，测试用例如下：

```javascript
test('test fetchData success', () => {
  return fetchData().then((res) => {
    expect(res.data).toEqual({
      success: true,
    })
  })
})

test('test fetchData success', () => {
  // 通过resolves能拿到获取到的数据
  // 只要数据中包含{data: {success: true}}，那么测试就会通过
  // 下面的return不能省略
  return expect(fetchData()).resolves.toMatchObject({
    data: {
      success: true,
    },
  })
})

// 使用await
test('test fetchData success', async () => {
  await expect(fetchData()).resolves.toMatchObject({
    data: {
      success: true,
    },
  })
})

test('test fetchData success', async () => {
  const res = await fetchData()
  expect(res.data).toEqual({
    success: true,
  })
})
```

如果接口请求失败，比如接口返回 404，测试用例如下：

```javascript
test('test fetchData 404', () => {
  // 如果接口没问题，那么catch中的语句就不会执行，通过expect.assertions(1)来限制后面必须执行一个expect，因为catch中的expect无法执行，因此该测试用例无法通过
  expect.assertions(1) // 如果有catch的话，一定要加上这条
  return fetchData().catch((e) => {
    expect(e.toString().includes('404')).toBe(true)
  })
})

test('test fetchData 404', () => {
  return expect(fetchData()).rejects.toThrow()
})

test('test fetchData 404', async () => {
  await expect(fetchData()).rejects.toThrow()
})

test('test fetchData 404', async () => {
  expect.assertions(1)
  try {
    await fetchData()
  } catch (e) {
    expect(e.toString()).toEqual('Error: Request failed with status code 404')
  }
})
```

## 钩子函数

Jest 钩子函数是指在 Jest 执行过程中的某些时刻会自动执行的函数。

1、beforeAll 会在所有测试用例执行之前执行，可以用来做一些准备工作。

2、afterAll 与 beforeAll 对应，会在所有测试用例执行结束之后执行。

3、beforeEach 会在每个测试用例执行之前执行。

4、afterEach 与 beforeEach 对应，会在每个测试用例执行之后执行。

```javascript
beforeAll(() => {
  console.log('beforeAll')
})

afterAll(() => {
  console.log('afterAll')
})

beforeEach(() => {
  console.log('beforeEach')
})

afterEach(() => {
  console.log('afterEach')
})
```

在 Jest 中，有时候我们会需要对一些测试用例进行分组，可以通过拆分测试文件的形式来实现分组，也可以使用 describe：

```javascript
describe('test description', () => {
  // 测试用例1
  // ...
  // 测试用例n
})
```

钩子函数的作用域：每个 describe 中都可以有上面的 4 个钩子函数，并且这些钩子函数对该 describe 中的所有测试用例都生效，包括嵌套 describe 中的测试用例。

补充：`test.only('test description', () => {})` 会 skip 其它测试用例，而只执行该测试用例。

注意：如果想写准备代码，千万不能直接写在 describe 中，而是应该写在钩子函数中，直接写在 describe 中的逻辑会在所有钩子函数执行之前执行。

## Mock

我们可以使用 Jest 提供的 Mock 

