# React 项目自动化测试

## 1 TDD 与 BDD

**测试驱动开发**（Test Driven Development，TDD）也叫红绿开发（Red-Green Development），其流程如下：

1、编写测试用例；

2、运行测试，这时候，测试用例无法通过测试；

3、编写代码，使测试用例通过测试；

4、优化代码，完成开发；

5、重复上述步骤。

**TDD 的优势：** 长期减少回归 bug；代码组织更合理，可维护性更高，代码质量更好；测试覆盖率高；不容易出现错误的测试代码。

**行为驱动开发**（Behavior Driven Development，BDD）是按照用户的行为进行开发并编写测试用例。

**TDD 与 BDD 的区别：**

| TDD                              | BDD                              |
| -------------------------------- | -------------------------------- |
| 先写测试再写代码                 | 先写代码再写测试                 |
| 一般结合单元测试使用，是白盒测试 | 一般结合集成测试使用，是黑盒测试 |
| 测试重点在代码                   | 测试重点在 UI（DOM）             |
| 安全感低                         | 安全感高                         |
| 速度快                           | 速度慢                           |

## 2 Enzyme

Enzyme 是 Airbnb 公司开源的一个用于 React 的 JavaScript 测试工具，方便判断、操纵和遍历 React 组件输出。Enzyme 的 API 模仿 jQuery，使得 DOM 操作和遍历很灵活、直观。Enzyme 兼容大多数断言库和测试框架。

在 React 项目中安装 Enzyme 以及其它插件：

```shell
npm install enzyme enzyme-adapter-react-16 jest-enzyme --save-dev 
```

如果我们写了一个 App 组件：

```react
import React from 'react'

function App() {
  return (
    <div className="app_container" title="zoeying" data-test="app_container">
      Hello World
    </div>
  )
}

export default App
```

那么，App 组件的测试用例可以这样写：

```react
import React from 'react'
import Enzyme, { shallow } from 'enzyme'
import Adapter from 'enzyme-adapter-react-16'
import App from './App'

Enzyme.configure({ adapter: new Adapter() })

it('test App use Enzyme', () => {
  // shallow表示浅渲染，只是渲染App组件，不关注App中的子组件是怎么渲染的，与之对应的API是mount
  const wrapper = shallow(<App />)

  expect(wrapper).toMatchSnapshot() // 快照测试

  // data-test属性值是'app_container'的元素，data-test是为了测试加的自定义属性，不使用class，是为了让测试与代码逻辑解耦
  const container = wrapper.find('[data-test="app_container"]')

  // console.log(wrapper.debug()) // 用于调试，如果测试用例跑不过，会打印出html

  expect(container.length).toBe(1)
  expect(container.prop('title')).toBe('zoeying') // 有title属性，且值是'zoeying'
})
```

我们还可以使用 jest-enzyme 提供的匹配器对上面的断言进行简化。

如果想使用 jest-enzyme，需要做一些配置。上面我们已经安装了 jest-enzyme，然后，在 jest.config.js 中修改配置如下：

```js
setupFilesAfterEnv: ['./node_modules/jest-enzyme/lib/index.js']
```

上面的配置表示，在测试环境启动好之后，会执行 ./node_modules/jest-enzyme/lib/index.js 文件，对 jest-enzyme 进行初始化。

这样，上面的两个断言就可以简写成如下的写法，其中 `.toExist`、`.toHaveProp` 都是 jest-enzyme 提供的匹配器：

```javascript
expect(container).toExist()
expect(container).toHaveProp('title', 'zoeying')
```

**补充：** **shallow** 主要用于**单元测试**，**mount** 主要用于**集成测试**。





















