# å¾®å‰ç«¯å­¦ä¹ ä¸å®è·µ

å¾®å‰ç«¯æ˜¯ä¸€ç§å¤šä¸ªå›¢é˜Ÿé€šè¿‡ç‹¬ç«‹å‘å¸ƒåŠŸèƒ½çš„æ–¹å¼æ¥å…±åŒæ„å»ºç°ä»£åŒ– Web åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µåŠæ–¹æ³•ç­–ç•¥ã€‚å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„æ—¶é—´è·¨åº¦ä¸‹ï¼Œç”±äºå‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿ï¼Œä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ªå·¨çŸ³åº”ç”¨åï¼Œéšä¹‹è€Œæ¥çš„åº”ç”¨ä¸å¯ç»´æŠ¤çš„é—®é¢˜ï¼Œè¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚

**å¾®å‰ç«¯æ¶æ„å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒä»·å€¼ï¼š**

- **æŠ€æœ¯æ ˆæ— å…³**

  ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå¾®åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒã€‚

- **ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²**

  å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°ã€‚

- **å¢é‡å‡çº§**

  åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥ã€‚

- **ç‹¬ç«‹è¿è¡Œæ—¶**

  æ¯ä¸ªå¾®åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«ã€‚

ç›®å‰ï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒæˆç†Ÿçš„å¾®å‰ç«¯æ¡†æ¶ï¼Œä¸€ä¸ªæ˜¯ single-spaï¼Œä¸€ä¸ªæ˜¯ qiankunã€‚

## 1 single-spa

single-spa æ˜¯ä¸€ä¸ªå°†å¤šä¸ªå•é¡µé¢åº”ç”¨èšåˆä¸ºä¸€ä¸ªæ•´ä½“åº”ç”¨çš„ JavaScript å¾®å‰ç«¯æ¡†æ¶ï¼Œå®ç°äº†è·¯ç”±åŠ«æŒå’Œåº”ç”¨åŠ è½½ï¼Œä½†æ˜¯å®ƒä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½åŠ¨æ€åŠ è½½ JavaScript æ–‡ä»¶ï¼Œä¸”æ²¡æœ‰åšåˆ°æ ·å¼éš”ç¦»ï¼Œä¹Ÿæ²¡æœ‰ JS æ²™ç®±æœºåˆ¶ã€‚

é…ç½® single-spa çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1ã€é€šè¿‡ Vue CLI åˆ›å»ºçˆ¶åº”ç”¨ parent-vue-project å’Œå­åº”ç”¨ child-vue-projectï¼š

```bash
vue create parent-vue-project
vue create child-vue-project
```

![image-20220302233801722](../images/image-20220302233801722.png)

2ã€åœ¨ child-vue-project ä¸­ï¼Œå®‰è£… single-spa-vueï¼Œåœ¨ main.js ä¸­å¯¼å‡ºä¸€äº›é’©å­å‡½æ•°ï¼Œå¹¶åšä¸€äº›é…ç½®ï¼š

```bash
npm install single-spa-vue --save 
```

```javascript
import Vue from "vue";
import App from "./App.vue";
import router from "./router";
import store from "./store";
import singleSpaVue from "single-spa-vue";

Vue.config.productionTip = false;

// å¯¹äºä½¿ç”¨äº†åŠ¨æ€è·¯ç”±çš„å­åº”ç”¨ï¼Œåœ¨åˆ‡æ¢è·¯ç”±æ—¶ï¼Œæ— æ³•æ‰¾åˆ°JSæ–‡ä»¶
// éœ€è¦é…ç½®æ‰“åŒ…åçš„æ–‡ä»¶å¼•ç”¨è·¯å¾„
if (window.singleSpaNavigate) {
  // eslint-disable-next-line no-undef
  __webpack_public_path__ = "http://localhost:10000/";
}

// å­åº”ç”¨å•ç‹¬è¿è¡Œ
if (!window.singleSpaNavigate) {
  new Vue({
    router,
    store,
    render: (h) => h(App),
  }).$mount("#app");
}

const appOptions = {
  // æŒ‚è½½åˆ°çˆ¶åº”ç”¨ä¸­idä¸ºchildVueProjectContainerçš„å…ƒç´ ä¸­
  el: "#childVueProjectContainer",
  router,
  store,
  render: (h) => h(App),
};

const lifeCycle = singleSpaVue({
  Vue,
  appOptions,
});

// åè®®æ¥å…¥ï¼Œçˆ¶åº”ç”¨ä¼šè°ƒç”¨è¿™äº›æ–¹æ³•
// çˆ¶åº”ç”¨åŠ è½½å­åº”ç”¨ï¼Œéœ€è¦å°†å­åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªä¸ªlibï¼Œç»™çˆ¶åº”ç”¨ä½¿ç”¨
export const bootstrap = lifeCycle.bootstrap;
export const mount = lifeCycle.mount;
export const unmount = lifeCycle.unmount;
```

3ã€åœ¨ child-vue-project é¡¹ç›®çš„ vue.config.js ä¸­å¢åŠ é…ç½®ï¼Œç”¨äºæŠŠå­åº”ç”¨æ‰“åŒ…æˆ libï¼š

```javascript
// è¿è¡Œæ—¶ï¼Œå­åº”ç”¨ä¼šè¢«æ‰“åŒ…ï¼Œå¹¶æŠŠå¯¼å‡ºçš„æ–¹æ³•æŒ‚è½½åˆ°windowå¯¹è±¡ä¸Š
module.exports = {
  configureWebpack: {
    output: {
      // æ‰“åŒ…å‡ºæ¥çš„libåº“çš„åå­—æ˜¯childVueProjectï¼Œä¸”æ˜¯umdæ¨¡å—
      // umdæ¨¡å—ä¼šæŠŠbootstrapã€mountã€unmountæ–¹æ³•æŒ‚è½½åˆ°window.childVueProjectä¸Š
      library: "childVueProject",
      libraryTarget: "umd",
    },
    devServer: {
      port: 10000,
    },
  },
};
```

ä»€ä¹ˆæ˜¯ umdï¼Ÿ

`commonJS`ã€`requireJS` éƒ½æ˜¯ç”¨æ¥å¤„ç† JS æ¨¡å—åŒ–çš„ï¼Œå…¶ä¸­ `commonJS` ç”¨æ¥ç»™ `nodejs` ä½¿ç”¨ï¼ˆä½¿ç”¨äº† `module.exports` çš„ç”¨æ³•ï¼‰ã€‚åæ¥ä½¿ç”¨ `import/export` æ¥å¯¼å…¥/å¯¼å‡ºæ¨¡å—ã€‚`umd` æ˜¯ç»Ÿä¸€æ¨¡å—å®šä¹‰æ–¹æ³•ï¼Œå¯ä»¥å…¼å®¹æ‰€æœ‰å…¶ä»–çš„æ¨¡å—å®šä¹‰æ–¹æ³•ã€‚

4ã€ä¿®æ”¹ child-vue-project çš„è·¯ç”±æ–‡ä»¶ï¼Œå¢åŠ è·¯ç”±å‰ç¼€ `/child-vue-project`ï¼š

```javascript
// ...
const router = new VueRouter({
  mode: "history",
  base: "/child-vue-project",
  routes,
});
```

5ã€åœ¨ parent-vue-project ä¸­ï¼Œå®‰è£… single-spaï¼ŒåŒæ—¶æ³¨å†Œå¹¶æŒ‚è½½å­åº”ç”¨ï¼š

```bash
npm install single-spa --save
```

```vue
<!-- App.vue -->
<template>
  <div id="app">
    <router-link to="/child-vue-project">åŠ è½½child-vue-project</router-link>
    <!-- åŠ è½½å­åº”ç”¨çš„ä½ç½® -->
    <div id="childVueProjectContainer"></div>
  </div>
</template>

<style lang="less"></style>
```

```javascript
// main.js
import Vue from "vue";
import App from "./App.vue";
import router from "./router";
import store from "./store";
import { registerApplication, start } from "single-spa";

Vue.config.productionTip = false;

async function loadScript(url) {
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = url;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

registerApplication(
  "childVueProject",
  async () => {
    // systemJS
    // åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾ï¼Œå¹¶å¼•å…¥è¯¥æ–‡ä»¶
    await loadScript("http://localhost:10000/js/chunk-vendors.js");
    await loadScript("http://localhost:10000/js/app.js");
    // window.childVueProjectä¸­æœ‰å­åº”ç”¨çš„bootstrapã€mountã€unmountæ–¹æ³•
    return window.childVueProject;
  },
  (location) => location.pathname.startsWith("/child-vue-project"),
  { msg: "ä¼ é€’åˆ°å­åº”ç”¨çš„æ•°æ®" }
);
start();

new Vue({
  router,
  store,
  render: (h) => h(App),
}).$mount("#app");
```

6ã€åˆ†åˆ«å¯åŠ¨ parent-vue-project å’Œ child-vue-projectã€‚

## 2 qiankun

qiankun æ˜¯ä¸€ä¸ªåŸºäº single-spa çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

**qiankun çš„ç‰¹æ€§ï¼š**

- ğŸ“¦ **åŸºäº [single-spa](https://github.com/CanopyTax/single-spa)** å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚
- ğŸ“± **æŠ€æœ¯æ ˆæ— å…³**ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ä½¿ç”¨/æ¥å…¥ï¼Œä¸è®ºæ˜¯ React/Vue/Angular/JQuery è¿˜æ˜¯å…¶ä»–ç­‰æ¡†æ¶ã€‚
- ğŸ’ª **HTML Entry æ¥å…¥æ–¹å¼**ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚
- ğŸ›¡ **æ ·å¼éš”ç¦»**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚
- ğŸ§³ **JS æ²™ç®±**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´**å…¨å±€å˜é‡/äº‹ä»¶**ä¸å†²çªã€‚
- âš¡ï¸ **èµ„æºé¢„åŠ è½½**
- åœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚
- ğŸ”Œ **umi æ’ä»¶**ï¼Œæä¾›äº† [@umijs/plugin-qiankun](https://github.com/umijs/plugins/tree/master/packages/plugin-qiankun) ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

**ä¸‹é¢ä»‹ç»ä½¿ç”¨ Vue æ­å»ºåŸºåº§é¡¹ç›®ï¼Œå¹¶é€šè¿‡ qiankun æ•´åˆ React é¡¹ç›®å’Œ Vue é¡¹ç›®çš„æ­¥éª¤ã€‚**

#### å®‰è£…é¡¹ç›®

ä½¿ç”¨å®˜æ–¹è„šæ‰‹æ¶æ­å»ºä¸‰ä¸ªé¡¹ç›®ï¼Œqiankun-base æ˜¯åŸºåº§é¡¹ç›®ï¼Œqiankun-vue å’Œ qiankun-react æ˜¯éœ€è¦æ•´åˆåˆ°åŸºåº§é¡¹ç›®ä¸Šçš„å­é¡¹ç›®ï¼š

```bash
vue create qiankun-base
```

```bash
vue create qiankun-vue
```

```bash
npx create-react-app qiankun-react
```

#### é…ç½® qiankun-base

1ã€å®‰è£… qiankunï¼š

```bash
npm install qiankun --save
```

2ã€åœ¨ main.js ä¸­æ³¨å†Œå­åº”ç”¨ï¼š

```javascript
import Vue from "vue";
import ElementUI from "element-ui";
import { registerMicroApps, start } from "qiankun";
import "element-ui/lib/theme-chalk/index.css";

import App from "./App.vue";
import router from "./router";

Vue.config.productionTip = false;

Vue.use(ElementUI);

const apps = [
  {
    name: "vueApp",
    // é»˜è®¤ä¼šåŠ è½½//localhost:5500çš„htmlï¼Œè§£æé‡Œé¢çš„jsï¼Œæ˜¯åŠ¨æ€æ‰§è¡Œçš„
    // å†…éƒ¨ç”¨fetchæ¥è¯»å–jsæ–‡ä»¶çš„
    // å­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸ
    entry: "//localhost:5500",
    // çˆ¶åº”ç”¨ä¸­çš„å®¹å™¨å…ƒç´ idï¼Œç”¨äºæŒ‚è½½å­åº”ç”¨
    container: "#vueApp",
    // è®¿é—®/vue-appæ—¶ï¼ŒæŠŠå­åº”ç”¨æŒ‚è½½åˆ°å…ƒç´ #vueAppä¸Š
    activeRule: "/vue-app",
    props: { msg: "ä¼ é€’ç»™vueAppçš„æ¶ˆæ¯" },
  },
  {
    name: "reactApp",
    // http://localhost:6600
    entry: "//localhost:6600",
    container: "#reactApp",
    activeRule: "/react-app",
  },
];

// æ³¨å†Œåº”ç”¨
// å¯ä»¥é€šè¿‡ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¢åŠ loadingç­‰æ•ˆæœ
registerMicroApps(apps, {
  beforeMount() {},
  afterMount() {},
});

start({
  prefetch: false, // å–æ¶ˆé¢„åŠ è½½
});

new Vue({
  router,
  render: (h) => h(App),
}).$mount("#app");
```

å½“å­åº”ç”¨ä¿¡æ¯æ³¨å†Œå®Œä¹‹åï¼Œä¸€æ—¦æµè§ˆå™¨çš„ url å‘ç”Ÿå˜åŒ–ï¼Œä¾¿ä¼šè‡ªåŠ¨è§¦å‘ qiankun çš„åŒ¹é…é€»è¾‘ï¼Œæ‰€æœ‰ activeRule è§„åˆ™åŒ¹é…ä¸Šçš„å­åº”ç”¨å°±ä¼šè¢«æ’å…¥åˆ°æŒ‡å®šçš„ container ä¸­ï¼ŒåŒæ—¶ä¾æ¬¡è°ƒç”¨å­åº”ç”¨æš´éœ²å‡ºçš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚

3ã€åœ¨ App.js ä¸­é…ç½®è·¯ç”±ï¼š

```vue
<template>
  <div>
    <el-menu :router="true" mode="horizontal">
      <!-- è‡ªå·±çš„è·¯ç”± -->
      <el-menu-item index="/">Home</el-menu-item>
      <!-- å¼•ç”¨å…¶å®ƒå­åº”ç”¨ -->
      <el-menu-item index="/vue-app">Vueåº”ç”¨</el-menu-item>
      <el-menu-item index="/react-app">Reactåº”ç”¨</el-menu-item>
    </el-menu>
    <router-view></router-view>
    <div id="vueApp"></div>
    <div id="reactApp"></div>
  </div>
</template>
```

#### é…ç½® qiankun-vue

1ã€é…ç½®è·¯ç”± baseï¼š

```javascript
// src/router/index.js

// ...

const router = new VueRouter({
  mode: "history",
  base: "/vue-app",
  routes,
});

export default router;
```

2ã€é…ç½®æ‰“åŒ…æ–¹å¼å’Œ devServerï¼š

```javascript
// vue.config.js
const { defineConfig } = require("@vue/cli-service");
module.exports = defineConfig({
  transpileDependencies: true,
  devServer: {
    port: 5500,
    headers: {
      // å¼€å‘ç¯å¢ƒä¸‹ï¼Œæ”¯æŒè·¨åŸŸ
      "Access-Control-Allow-Origin": "*",
    },
  },
  configureWebpack: {
    output: {
      library: "vueApp",
      libraryTarget: "umd",
    },
  },
});
```

3ã€åœ¨å…¥å£å‡½æ•° main.js ä¸­ï¼Œé…ç½®ç‹¬ç«‹è¿è¡Œã€é…ç½® publicPathã€å¯¼å‡ºåè®®å‡½æ•°ç­‰ï¼š

```javascript
import Vue from "vue";
import App from "./App.vue";
import router from "./router";

Vue.config.productionTip = false;

let instance = null;
function render(props) {
  instance = new Vue({
    router,
    render: (h) => h(App),
    // æŒ‚è½½åˆ°è‡ªå·±çš„HTMLä¸­ï¼ŒåŸºåº§ä¼šæ‹¿åˆ°è¿™ä¸ªæŒ‚è½½åçš„HTMLï¼Œæ’å…¥åˆ°åŸºåº§#vueAppå…ƒç´ ä¸­
  }).$mount("#app");
}

// qiankunå°†ä¼šåœ¨å¾®åº”ç”¨bootstrapä¹‹å‰æ³¨å…¥ä¸€ä¸ªè¿è¡Œæ—¶çš„publicPathå˜é‡
// runtime publicPathä¸»è¦è§£å†³çš„æ˜¯å¾®åº”ç”¨åŠ¨æ€è½½å…¥çš„è„šæœ¬ã€æ ·å¼ã€å›¾ç‰‡ç­‰åœ°å€ä¸æ­£ç¡®çš„é—®é¢˜
// åŠ¨æ€æ·»åŠ publicPath
if (window.__POWERED_BY_QIANKUN__) {
  // eslint-disable-next-line no-undef
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}

// åº”ç”¨ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

export async function bootstrap(props) {}

export async function mount(props) {
  // çˆ¶åº”ç”¨é€šè¿‡propsä¼ é€’æ•°æ®è¿‡æ¥
  // console.log(props);
  render(props);
}

export async function unmount(props) {
  instance.$destroy();
  instance = null;
}
```

#### é…ç½® qiankun-react

1ã€åœ¨ App.js ä¸­é…ç½®è·¯ç”±ï¼š

```jsx
import { BrowserRouter, Routes, Route, Link } from 'react-router-dom'

function Home() {
  return <h2>Home Page</h2>
}

function About() {
  return <h2>About Page</h2>
}

function App() {
  return (
    <BrowserRouter basename="/react-app">
      <Link to="/">é¦–é¡µ</Link>
      <Link to="/about">å…³äºé¡µé¢</Link>
      <Routes>
        <Route path="/" exact element={<Home></Home>} />
        <Route path="/about" element={<About></About>} />
      </Routes>
    </BrowserRouter>
  )
}

export default App
```

2ã€åœ¨ config-overrides.js ä¸­ï¼Œé…ç½®è·¨åŸŸå’Œæ‰“åŒ…æ–¹å¼ï¼š

```javascript
// éœ€è¦äº†è§£å¦‚ä½•ä½¿ç”¨react-app-rewiredä¿®æ”¹create-react-appé¡¹ç›®çš„é…ç½®
module.exports = {
  webpack: config => {
    config.output.library = 'reactApp'
    config.output.libraryTarget = 'umd'
    // è®¿é—®èµ„æºè·¯å¾„
    config.output.publicPath = 'http://localhost:6600/'
    return config
  },
  devServer: configFunction => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost)
      config.headers = {
        'Access-Control-Allow-Origin': '*',
      }
      return config
    }
  },
}
```

3ã€æ–°å¢ .env æ–‡ä»¶ï¼Œé…ç½®ç«¯å£å·ï¼š

```bash
PORT=6600
WDS_SOCKET_PORT=6600
```

é…ç½® WDS_SOCKET_PORTï¼Œé˜²æ­¢çƒ­æ›´æ–°å¤±è´¥ã€‚

4ã€åœ¨å…¥å£æ–‡ä»¶ index.js ä¸­ï¼Œé…ç½®ç‹¬ç«‹è¿è¡Œã€å¯¼å‡ºåè®®å‡½æ•°ï¼š

```jsx
import React from 'react'
import ReactDOM from 'react-dom'
import App from './App'

function render() {
  ReactDOM.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>,
    document.getElementById('root')
  )
}

// åº”ç”¨ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render()
}

export async function bootstrap() {}

export async function mount() {
  render()
}

export async function unmount() {
  ReactDOM.unmountComponentAtNode(document.getElementById('root'))
}
```

## 3 äº†è§£

### 3.1 ä¸»å­åº”ç”¨é€šä¿¡

1ã€åŸºäº URL è¿›è¡Œæ•°æ®ä¼ é€’ï¼ˆä¼ é€’æ¶ˆæ¯èƒ½åŠ›è¾ƒå¼±ï¼‰ï¼›

2ã€åŸºäº CustomEvent å®ç°é€šä¿¡ï¼›

3ã€åŸºäº props åœ¨ä¸»å­åº”ç”¨ä¹‹é—´é€šä¿¡ï¼›

4ã€ä½¿ç”¨å…¨å±€å˜é‡ã€Redux è¿›è¡Œé€šä¿¡ã€‚

å¯¹äºä¸»å­åº”ç”¨çš„å…¬å…±ä¾èµ–ï¼Œå¯ä»¥é€šè¿‡ CDN å¼•å…¥å¤–éƒ¨ä¾èµ–æˆ–è€…ä½¿ç”¨ Webpack5 è”é‚¦æ¨¡å—ã€‚

### 3.2 æ ·å¼éš”ç¦»

**å­åº”ç”¨ä¹‹é—´æ ·å¼éš”ç¦»ï¼š**

å¯ä»¥ä½¿ç”¨åŠ¨æ€æ ·å¼è¡¨ï¼Œå½“åº”ç”¨åˆ‡æ¢æ—¶ï¼Œç§»é™¤è€åº”ç”¨æ ·å¼ï¼Œæ·»åŠ æ–°åº”ç”¨æ ·å¼ã€‚

**ä¸»å­åº”ç”¨ä¹‹é—´æ ·å¼éš”ç¦»æ–¹æ¡ˆï¼š**

1ã€BEMï¼ˆBlock Element Modifierï¼‰çº¦å®šé¡¹ç›®å‰ç¼€ï¼›

2ã€CSS Modulesï¼Œæ‰“åŒ…æ—¶ç”Ÿæˆä¸å†²çªçš„é€‰æ‹©å™¨åï¼Œæ¯”è¾ƒä¸»æµï¼›

3ã€css-in-jsï¼Œä¸æ¨èä½¿ç”¨ï¼›

4ã€Shadow DOMï¼ŒçœŸæ­£æ„ä¹‰ä¸Šçš„éš”ç¦»ï¼Œä¹Ÿæ˜¯ qiankun ä½¿ç”¨çš„æ–¹æ¡ˆã€‚

Shadow DOM ä¾‹å­ï¼š

```html
<body>
  <div>
    <p>Hello World</p>
    <div id="shadow"></div>
  </div>
  <script>
    // closedè¡¨ç¤ºå¤–ç•Œæ— æ³•è®¿é—®Shadow DOM
    // å¯¹äºåœ¨bodyä¸Šæ·»åŠ å±æ€§çš„å­é¡¹ç›®ï¼Œæ¯”å¦‚ä¸€äº›ç»„ä»¶å¼¹æ¡†æ˜¯ç›´æ¥æŒ‚åœ¨bodyä¸Šçš„ï¼ŒShadow DOMæ— æ³•åšåˆ°æ ·å¼éš”ç¦»
    let shadowDom = document.getElementById("shadow").attachShadow({ mode: "closed" });
    let pElement = document.createElement("p");
    pElement.innerHTML = "Shadow DOM";
    let styleElement = document.createElement("style");
    styleElement.textContent = "p{ color: blue; } ";
    shadowDom.appendChild(styleElement);
    shadowDom.appendChild(pElement);
  </script>
</body>
```

### 3.3 JS æ²™ç®±

å¦‚æœå­åº”ç”¨å‘ window ä¸Šæ·»åŠ äº†å±æ€§ï¼Œä¸”å…¶å®ƒå­åº”ç”¨èƒ½è®¿é—®åˆ°ï¼Œå°±é€ æˆäº†å…¨å±€æ±¡æŸ“ã€‚å¯ä»¥ä½¿ç”¨ JS æ²™ç®±æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

JS æ²™ç®±åŒ…æ‹¬**ä»£ç†æ²™ç®±**å’Œ**å¿«ç…§æ²™ç®±**ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å¿«ç…§æ²™ç®±**ä¸é€‚ç”¨äºå¤šåº”ç”¨ã€‚å¦‚æœæ˜¯**å¤šåº”ç”¨**ï¼Œæ¨èä½¿ç”¨**ä»£ç†æ²™ç®±**ï¼ˆES6 Proxyï¼‰ã€‚ä»£ç†æ²™ç®±çš„åŸç†æ˜¯ä½¿ç”¨ä¸åŒçš„ Proxy æ¥å¤„ç†ä¸åŒçš„åº”ç”¨ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæ‰‹å†™å¿«ç…§æ²™ç®±çš„ä¾‹å­ï¼š

```html
<script>
  class SnapshotSandbox {
    constructor() {
      this.proxy = window
      this.modifyPropsMap = {} // è®°å½•åœ¨windowä¸Šçš„ä¿®æ”¹
      this.active()
    }

    active() {
      this.windowSnapshot = {}
      for (const prop in window) {
        if (window.hasOwnProperty(prop)) {
          this.windowSnapshot[prop] = window[prop]
        }
      }

      Object.keys(this.modifyPropsMap).forEach(p => {
        window[p] = this.modifyPropsMap[p]
      })
    }

    deactive() {
      for (const prop in window) {
        if (window.hasOwnProperty(prop)) {
          if (window[prop] !== this.windowSnapshot[prop]) {
            this.modifyPropsMap[prop] = window[prop]
            window[prop] = this.windowSnapshot[prop]
          }
        }
      }
    }
  }

  let sandbox = new SnapshotSandbox()
  ;(window => {
    window.a = 1
    window.b = 2
    console.log(window.a, window.b)
    sandbox.deactive()
    console.log(window.a, window.b)
    sandbox.active()
    console.log(window.a, window.b)
  })(sandbox.proxy) // sandbox.proxyå°±æ˜¯window
</script>
```

**è¡¥å……ï¼š** åœ¨è®¡ç®—æœºå®‰å…¨ä¸­ï¼Œ**æ²™ç®±ï¼ˆSandboxï¼‰æ˜¯ä¸€ç§ç”¨äºéš”ç¦»æ­£åœ¨è¿è¡Œç¨‹åºçš„å®‰å…¨æœºåˆ¶**ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œæœªç»æµ‹è¯•æˆ–ä¸å—ä¿¡ä»»çš„ç¨‹åºæˆ–ä»£ç ï¼Œå®ƒä¼š**ä¸ºå¾…æ‰§è¡Œçš„ç¨‹åºåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒï¼Œå†…éƒ¨ç¨‹åºçš„æ‰§è¡Œä¸ä¼šå½±å“åˆ°å¤–éƒ¨ç¨‹åºçš„è¿è¡Œ**ã€‚
